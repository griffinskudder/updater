name: Publish

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

permissions: {}

jobs:
  publish:
    name: Build and push to GHCR
    runs-on: ubuntu-latest
    if: github.ref_type == 'branch'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        env:
          DOCKER_REGISTRY: ghcr.io/${{ github.repository_owner }}
        run: |
          chmod +x ./scripts/docker-build.sh
          make docker-push

  release:
    name: Build, push, and release
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        env:
          DOCKER_REGISTRY: ghcr.io/${{ github.repository_owner }}
          VERSION: ${{ github.ref_name }}
        run: |
          chmod +x ./scripts/docker-build.sh
          make docker-push

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes
